
<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.5.1 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>IPOP</title>




<meta name="description" content="IP-Over-P2P, Open-source User-centric Software Virtual Network">




<meta name="author" content="">

<meta property="og:locale" content="en">
<meta property="og:site_name" content="IPOP">
<meta property="og:title" content="IPOP">








  

  












  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "IPOP",
      "url" : null,
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="IPOP Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->
  </head>

  <body class="layout--wiki">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">IPOP</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="/about/">About</a></li>
          
            
            <li class="masthead__menu-item"><a href="/wiki/Quick-Start">Quick Start</a></li>
          
            
            <li class="masthead__menu-item"><a href="/download">Download</a></li>
          
            
            <li class="masthead__menu-item"><a href="/learn/">Learn</a></li>
          
            
            <li class="masthead__menu-item"><a href="/wiki/">Wiki</a></li>
          
            
            <li class="masthead__menu-item"><a href="/whitepaper/">White Paper</a></li>
          
            
            <li class="masthead__menu-item"><a href="/contribute/">Contribute</a></li>
          
            
            <li class="masthead__menu-item"><a href="/contact/">Contact</a></li>
          
        </ul>
        <button><div class="navicon"></div></button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    



<div id="main" role="main">
  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      <section class="page__content" itemprop="text">

        <aside class="sidebar__right">
          <nav class="toc">
            <header><h4 class="nav__title"><i class="fa fa-file-text"></i> On This Page</h4></header>
            <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a>
<ul>
<li class="toc-entry toc-h2"><a href="#installation-and-configuration">Installation and Configuration</a></li>
<li class="toc-entry toc-h2"><a href="#creating-certificates">Creating certificates</a></li>
<li class="toc-entry toc-h2"><a href="#racoonconf">racoon.conf</a></li>
<li class="toc-entry toc-h2"><a href="#assumptions">Assumptions</a></li>
</ul>
</li>
</ul>
          </nav>
        </aside>

        <h1 id="introduction">Introduction</h1>

<p>This article describes how to deploy IPsec using Racoon framework to add another layer of security in addition to DTLS encryption provided by IPoP. The setup described in this article needs two OVS bridges, one setup by IPoP by default and another one to serve as gateway for IPsec protected traffic. We leverage GRE encapsulation by creating GRE tunnels using IPoP addresses as endpoints and configure IPsec policies based on IPoP subnet range. This approach simplifies the process of setting up IPsec policies, a single policy can be used to cover all data traffic bridged to gateway switch .</p>

<p>In the following article we go over the steps to create, configure and test this setup using two hosts and network namspaces emulating devices on each of them. In the first stage we create a GRE tunnel over IPoP and check the connectivity between network namespaces which are bridged to gateway switches on their respective hosts. Once we have verified connectivity between the namespaces over GRE we proceed with configuring IPSec.</p>

<h2 id="installation-and-configuration">Installation and Configuration</h2>
<p>First step is to install and activate IPoP on the hosts. Once done, make sure that the hosts can connect with each other over IPoP overlay. The following steps detail the process of installing additional packages.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># create gateway bridge</span>
sudo ovs-vsctl add-br GRE-BR
<span class="c"># create a GRE tunnel with remote endpoint as IPoP address of the remote peer (192.168.1.121).</span>
sudo ovs-vsctl add-port GRE-BR gre1 -- <span class="nb">set </span>interface gre1 <span class="nb">type</span><span class="o">=</span>gre options:remote_ip<span class="o">=</span>192.168.1.121
<span class="c"># create a network namespace named D1</span>
sudo ip netns add D1
<span class="c"># create a veth pair</span>
sudo ip link add veth0 <span class="nb">type </span>veth peer name veth1
<span class="c"># assign one end of veth pair to namespace D1</span>
sudo ip link <span class="nb">set </span>veth1 netns D1
<span class="c"># configure the veth endpoint in namespace D1 with a IP address</span>
sudo ip netns <span class="nb">exec </span>D1 ifconfig veth1 10.10.10.100/24 up
<span class="c"># Bring up the veth interface in namespace UP</span>
sudo ip netns <span class="nb">exec </span>D1 ip link <span class="nb">set </span>veth1 up
<span class="c"># Attach veth interface on host to gateway bridge</span>
sudo ovs-vsctl add-port GRE-BR veth0
<span class="c"># Bring up the veth interface in host UP</span>
sudo ip link <span class="nb">set </span>veth0 up
</code></pre>
</div>
<p>Repeat similar process on the second host, assuming IPoP endpoint on the host is 192.168.1.121.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo ovs-vsctl add-br GRE-BR
sudo ovs-vsctl add-port GRE-BR gre1 -- <span class="nb">set </span>interface gre1 <span class="nb">type</span><span class="o">=</span>gre options:remote_ip<span class="o">=</span>192.168.1.120
sudo ip netns add D2
sudo ip link add veth0 <span class="nb">type </span>veth peer name veth1
sudo ip link <span class="nb">set </span>veth1 netns D2
sudo ip netns <span class="nb">exec </span>D2 ifconfig veth1 10.10.10.101/24 up
sudo ip netns <span class="nb">exec </span>D2 ip link <span class="nb">set </span>veth1 up
sudo ovs-vsctl add-port GRE-BR veth0
sudo ip link <span class="nb">set </span>veth0 up
</code></pre>
</div>
<p>Now verify connectivity between the network namespaces.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">sam@node-0:~$ </span>sudo ip netns <span class="nb">exec </span>D1 ping 10.10.10.101
PING 10.10.10.101 <span class="o">(</span>10.10.10.101<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>3.09 ms
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>4 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.43 ms
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>5 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.30 ms
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>6 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.33 ms
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>7 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.34 ms
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>8 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.29 ms
64 bytes from 10.10.10.101: <span class="nv">icmp_seq</span><span class="o">=</span>9 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.32 ms
</code></pre>
</div>
<p>If this step is successful proceed with installation and configuration of Racoon framework on the hosts.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo apt-get install racoon ipsec-tools
</code></pre>
</div>
<p>Before proceeding further we will need to create keys and certificates for our hosts.</p>

<h2 id="creating-certificates">Creating certificates</h2>
<p>Root key</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code> openssl genrsa -out rootCA.key 2048
</code></pre>
</div>
<p>Root certificate</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl req -x509 -new -nodes -key rootCA.key -days 1024 -out rootCA.pem
</code></pre>
</div>
<p>Once we have rootCA and rootCA-key, we can attest certificates for peers.<br />
create a private key for the peer.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl genrsa -out key.pem 2048
</code></pre>
</div>
<p>create a certificate signing request.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl req -new -key key.pem -out device.csr
</code></pre>
</div>
<p>Point to be noted– The CN (Common Name) should be your public IP endpoint, or your DNS Hostname. 
The entity owning the rootCA can than service this request and create a signed certificate</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl x509 -req -in device.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out cert.pem -days 500
</code></pre>
</div>
<p>Now place the rootCA.pem, peer certificate and key in “/etc/racoon/certs”, create the path if it does not exist. It must look like:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">sam@node-0:/etc/racoon/certs$ </span>ls
cert.pem  device.csr  key.pem  rootCA.pem
</code></pre>
</div>
<p>Next step is to configure racoon by making changes to racoon.conf file found in /etc/racoon</p>

<h2 id="racoonconf">racoon.conf</h2>
<p>On host-1</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>path pre_shared_key <span class="s2">"/etc/racoon/psk.txt"</span>;
path certificate <span class="s2">"/etc/racoon/certs"</span>;

listen
<span class="o">{</span>   <span class="c"># public IP endpoint for self.</span>
    isakmp 192.168.1.120 <span class="o">[</span>500];
    isakmp_natt 192.168.1.120 <span class="o">[</span>4500];
<span class="o">}</span>

remote anonymous <span class="o">{</span>
        proposal <span class="o">{</span>
                encryption_algorithm 3des;
                hash_algorithm sha1;
                authentication_method rsasig;
        dh_group modp1024;
        <span class="o">}</span>
        certificate_type x509 <span class="s2">"cert.pem"</span> <span class="s2">"key.pem"</span>;
        ca_type x509 <span class="s2">"rootCA.pem"</span> ;
        my_identifier asn1dn ;
        verify_identifier off;
        exchange_mode main;
        nat_traversal on;
<span class="o">}</span>
sainfo anonymous <span class="o">{</span>
     authentication_algorithm hmac_sha1;
     compression_algorithm deflate;
        pfs_group modp1024;
        encryption_algorithm 3des;
<span class="o">}</span>
</code></pre>
</div>
<p>On host-2</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>path pre_shared_key <span class="s2">"/etc/racoon/psk.txt"</span>;
path certificate <span class="s2">"/etc/racoon/certs"</span>;

listen
<span class="o">{</span>   <span class="c"># public IP endpoint for self.</span>
    isakmp 192.168.1.121 <span class="o">[</span>500];
    isakmp_natt 192.168.1.121 <span class="o">[</span>4500];
<span class="o">}</span>

remote anonymous <span class="o">{</span>
        proposal <span class="o">{</span>
                encryption_algorithm 3des;
                hash_algorithm sha1;
                authentication_method rsasig;
        dh_group modp1024;
        <span class="o">}</span>
        certificate_type x509 <span class="s2">"cert.pem"</span> <span class="s2">"key.pem"</span>;
        ca_type x509 <span class="s2">"rootCA.pem"</span> ;
        my_identifier asn1dn ;
        verify_identifier off;
        exchange_mode main;
        nat_traversal on;
<span class="o">}</span>
sainfo anonymous <span class="o">{</span>
     authentication_algorithm hmac_sha1;
     compression_algorithm deflate;
        pfs_group modp1024;
        encryption_algorithm 3des;
<span class="o">}</span>

</code></pre>
</div>
<p>To do manual security-association management, the script below script can be used. The controller will otherwise automatically take care of it.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">#! /bin/bash</span>
setkey -c <span class="sh">&lt;&lt; EOF
#flush ;
#spdflush ;
spdadd 192.168.1.0/24 192.168.1.0/24 any -P out ipsec esp/transport//require ;
spdadd 192.168.1.0/24 192.168.1.0/24 any -P in  ipsec esp/transport//require ;
EOF
</span></code></pre>
</div>
<p>Once the racoon daemon is running, you can use execute the script to add security associations. For “out” rule first field is local address range, followed by remote address range on which IPsec is to be triggered. For “in” the first field is remote followed by local. We use ESP-Transport mode. The above file should have permissions as shown below.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>-rwxr-xr-x 1 root root             213 Oct 18 14:21 ipsec.sh
</code></pre>
</div>
<h2 id="assumptions">Assumptions</h2>
<p>IPsec racoon daemon is already running, ensure that no un-wanted security associations are active. This can be done on command line by using</p>

<p>Start racoon in Foreground</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code> /usr/sbin/racoon -F
</code></pre>
</div>
<p>OR <br />
Start racoon in background.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo /etc/init.d/racoon start
</code></pre>
</div>
<p>To check current security associations.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code> setkey -DP
</code></pre>
</div>
<p>In case you made a mistake while setting up configuration, you can purge the policies by using</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"spdflush; flush;"</span> | sudo setkey -c
</code></pre>
</div>
<p>The below IPsec logs depict successful set up of IPsec</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">sam@sam-T520:/etc/racoon$ </span>sudo /usr/sbin/racoon -F
<span class="o">[</span>sudo] password <span class="k">for </span>sam: 
Foreground mode.
<span class="gp">sam@node-0:~$ </span>sudo /usr/sbin/racoon -F
Foreground mode.
2018-10-18 14:22:43: INFO: @<span class="o">(</span><span class="c">#)ipsec-tools 0.8.2 (http://ipsec-tools.sourceforge.net)</span>
2018-10-18 14:22:43: INFO: @<span class="o">(</span><span class="c">#)This product linked OpenSSL 1.0.2n  7 Dec 2017 (http://www.openssl.org/)</span>
2018-10-18 14:22:43: INFO: Reading configuration from <span class="s2">"/etc/racoon/racoon.conf"</span>
2018-10-18 14:22:43: INFO: 192.168.1.120[4500] used <span class="k">for </span>NAT-T
2018-10-18 14:22:43: INFO: 192.168.1.120[4500] used as isakmp port <span class="o">(</span><span class="nv">fd</span><span class="o">=</span>7<span class="o">)</span>
2018-10-18 14:22:43: INFO: 192.168.1.120[500] used <span class="k">for </span>NAT-T
2018-10-18 14:22:43: INFO: 192.168.1.120[500] used as isakmp port <span class="o">(</span><span class="nv">fd</span><span class="o">=</span>8<span class="o">)</span>
2018-10-18 14:25:02: INFO: unsupported PF_KEY message REGISTER
2018-10-18 14:26:33: INFO: IPsec-SA request <span class="k">for </span>192.168.1.121 queued due to no phase1 found.
2018-10-18 14:26:33: INFO: initiate new phase 1 negotiation: 192.168.1.120[500]&lt;<span class="o">=</span>&gt;192.168.1.121[500]
2018-10-18 14:26:33: INFO: begin Identity Protection mode.
2018-10-18 14:26:33: INFO: received Vendor ID: RFC 3947
2018-10-18 14:26:33: INFO: received Vendor ID: DPD
2018-10-18 14:26:33: <span class="o">[</span>192.168.1.121] INFO: Selected NAT-T version: RFC 3947
2018-10-18 14:26:33: <span class="o">[</span>192.168.1.121] INFO: Hashing 192.168.1.121[500] with algo <span class="c">#2 </span>
2018-10-18 14:26:33: <span class="o">[</span>192.168.1.120] INFO: Hashing 192.168.1.120[500] with algo <span class="c">#2 </span>
2018-10-18 14:26:33: INFO: Adding remote and <span class="nb">local </span>NAT-D payloads.
2018-10-18 14:26:33: <span class="o">[</span>192.168.1.120] INFO: Hashing 192.168.1.120[500] with algo <span class="c">#2 </span>
2018-10-18 14:26:33: INFO: NAT-D payload <span class="c">#0 verified</span>
2018-10-18 14:26:33: <span class="o">[</span>192.168.1.121] INFO: Hashing 192.168.1.121[500] with algo <span class="c">#2 </span>
2018-10-18 14:26:33: INFO: NAT-D payload <span class="c">#1 verified</span>
2018-10-18 14:26:33: INFO: NAT not detected 
2018-10-18 14:26:33: WARNING: unable to get certificate CRL<span class="o">(</span>3<span class="o">)</span> at depth:0 SubjectName:/C<span class="o">=</span>US/ST<span class="o">=</span>FL/L<span class="o">=</span>GNV/O<span class="o">=</span>Internet Widgits Pty Ltd/CN<span class="o">=</span>192.168.1.121
2018-10-18 14:26:33: WARNING: unable to get certificate CRL<span class="o">(</span>3<span class="o">)</span> at depth:1 SubjectName:/C<span class="o">=</span>US/ST<span class="o">=</span>Florida/L<span class="o">=</span>gainesville/O<span class="o">=</span>IPOP/OU<span class="o">=</span>IPOP/CN<span class="o">=</span>IPOP
2018-10-18 14:26:33: INFO: ISAKMP-SA established 192.168.1.120[500]-192.168.1.121[500] spi:b0c0a9fc47480115:21942c95b1bbfdbe
2018-10-18 14:26:33: <span class="o">[</span>192.168.1.121] INFO: received INITIAL-CONTACT
2018-10-18 14:26:34: INFO: initiate new phase 2 negotiation: 192.168.1.120[500]&lt;<span class="o">=</span>&gt;192.168.1.121[500]
2018-10-18 14:26:34: INFO: IPsec-SA established: ESP/Transport 192.168.1.120[500]-&gt;192.168.1.121[500] <span class="nv">spi</span><span class="o">=</span>252339908<span class="o">(</span>0xf0a66c4<span class="o">)</span>
2018-10-18 14:26:34: INFO: IPsec-SA established: ESP/Transport 192.168.1.120[500]-&gt;192.168.1.121[500] <span class="nv">spi</span><span class="o">=</span>212878123<span class="o">(</span>0xcb0432b<span class="o">)</span>



</code></pre>
</div>
<p>Note both the   “2018-10-18 14:26:34: INFO: IPsec-SA established: ESP/Transport 192.168.1.120[500]-&gt;192.168.1.121[500] spi=252339908(0xf0a66c4)” which denotes successful phase1 and “2018-10-18 14:26:34: INFO: IPsec-SA established: ESP/Transport 192.168.1.120[500]-&gt;192.168.1.121[500] spi=212878123(0xcb0432b)” phase2 stages respectively.</p>

<p>tcp-dump output when sending ICMP messages between network namespaces as captured on the Linux node hosting namespaces.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">sam@node-1:~$ </span>sudo tcpdump -ni any -v esp
tcpdump: listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size 262144 bytes
14:27:26.317303 IP <span class="o">(</span>tos 0x0, ttl 64, id 2328, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x38<span class="o">)</span>, length 132
14:27:26.317303 IP <span class="o">(</span>tos 0x0, ttl 64, id 2328, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x38<span class="o">)</span>, length 132
14:27:26.317462 IP <span class="o">(</span>tos 0x0, ttl 64, id 21351, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.121 &gt; 192.168.1.120: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0f0a66c4,seq<span class="o">=</span>0x38<span class="o">)</span>, length 132
14:27:26.317467 IP <span class="o">(</span>tos 0x0, ttl 64, id 21351, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.121 &gt; 192.168.1.120: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0f0a66c4,seq<span class="o">=</span>0x38<span class="o">)</span>, length 132
14:27:27.318861 IP <span class="o">(</span>tos 0x0, ttl 64, id 2426, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x39<span class="o">)</span>, length 132
14:27:27.318861 IP <span class="o">(</span>tos 0x0, ttl 64, id 2426, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x39<span class="o">)</span>, length 132
14:27:27.319004 IP <span class="o">(</span>tos 0x0, ttl 64, id 21517, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.121 &gt; 192.168.1.120: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0f0a66c4,seq<span class="o">=</span>0x39<span class="o">)</span>, length 132
14:27:27.319010 IP <span class="o">(</span>tos 0x0, ttl 64, id 21517, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.121 &gt; 192.168.1.120: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0f0a66c4,seq<span class="o">=</span>0x39<span class="o">)</span>, length 132
14:27:28.320513 IP <span class="o">(</span>tos 0x0, ttl 64, id 2574, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x3a<span class="o">)</span>, length 132
14:27:28.320513 IP <span class="o">(</span>tos 0x0, ttl 64, id 2574, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x3a<span class="o">)</span>, length 132
14:27:28.320652 IP <span class="o">(</span>tos 0x0, ttl 64, id 21618, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.121 &gt; 192.168.1.120: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0f0a66c4,seq<span class="o">=</span>0x3a<span class="o">)</span>, length 132
14:27:28.320657 IP <span class="o">(</span>tos 0x0, ttl 64, id 21618, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.121 &gt; 192.168.1.120: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0f0a66c4,seq<span class="o">=</span>0x3a<span class="o">)</span>, length 132
14:27:29.322088 IP <span class="o">(</span>tos 0x0, ttl 64, id 2677, offset 0, flags <span class="o">[</span>DF], proto ESP <span class="o">(</span>50<span class="o">)</span>, length 152<span class="o">)</span>
    192.168.1.120 &gt; 192.168.1.121: ESP<span class="o">(</span><span class="nv">spi</span><span class="o">=</span>0x0cb0432b,seq<span class="o">=</span>0x3b<span class="o">)</span>, length 132


</code></pre>
</div>
<p>Check Security associations–</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">sam@node-1:~$ </span>sudo setkey -DP
192.168.1.0/24[any] 192.168.1.0/24[any] 255
	fwd prio def ipsec
	esp/transport//require
	created: Oct 18 14:25:10 2018  lastused:                     
	lifetime: 0<span class="o">(</span>s<span class="o">)</span> validtime: 0<span class="o">(</span>s<span class="o">)</span>
	<span class="nv">spid</span><span class="o">=</span>370 <span class="nv">seq</span><span class="o">=</span>1 <span class="nv">pid</span><span class="o">=</span>24623
	<span class="nv">refcnt</span><span class="o">=</span>1
192.168.1.0/24[any] 192.168.1.0/24[any] 255
	<span class="k">in </span>prio def ipsec
	esp/transport//require
	created: Oct 18 14:25:10 2018  lastused: Oct 18 15:00:25 2018
	lifetime: 0<span class="o">(</span>s<span class="o">)</span> validtime: 0<span class="o">(</span>s<span class="o">)</span>
	<span class="nv">spid</span><span class="o">=</span>360 <span class="nv">seq</span><span class="o">=</span>2 <span class="nv">pid</span><span class="o">=</span>24623
	<span class="nv">refcnt</span><span class="o">=</span>1
192.168.1.0/24[any] 192.168.1.0/24[any] 255
	out prio def ipsec
	esp/transport//require
	created: Oct 18 14:25:10 2018  lastused: Oct 18 14:45:08 2018
	lifetime: 0<span class="o">(</span>s<span class="o">)</span> validtime: 0<span class="o">(</span>s<span class="o">)</span>
	<span class="nv">spid</span><span class="o">=</span>353 <span class="nv">seq</span><span class="o">=</span>3 <span class="nv">pid</span><span class="o">=</span>24623
	<span class="nv">refcnt</span><span class="o">=</span>4
<span class="o">(</span>per-socket policy<span class="o">)</span> 
	out<span class="o">(</span>socket<span class="o">)</span> none
	created: Oct 18 14:22:47 2018  lastused: Oct 18 14:26:34 2018
	lifetime: 0<span class="o">(</span>s<span class="o">)</span> validtime: 0<span class="o">(</span>s<span class="o">)</span>
	<span class="nv">spid</span><span class="o">=</span>348 <span class="nv">seq</span><span class="o">=</span>4 <span class="nv">pid</span><span class="o">=</span>24623
	<span class="nv">refcnt</span><span class="o">=</span>1
<span class="o">(</span>per-socket policy<span class="o">)</span> 
	<span class="k">in</span><span class="o">(</span>socket<span class="o">)</span> none
	created: Oct 18 14:22:47 2018  lastused: Oct 18 14:26:34 2018
	lifetime: 0<span class="o">(</span>s<span class="o">)</span> validtime: 0<span class="o">(</span>s<span class="o">)</span>
	<span class="nv">spid</span><span class="o">=</span>339 <span class="nv">seq</span><span class="o">=</span>5 <span class="nv">pid</span><span class="o">=</span>24623
	<span class="nv">refcnt</span><span class="o">=</span>1
<span class="o">(</span>per-socket policy<span class="o">)</span> 
	out<span class="o">(</span>socket<span class="o">)</span> none
	created: Oct 18 14:22:47 2018  lastused:                     
	lifetime: 0<span class="o">(</span>s<span class="o">)</span> validtime: 0<span class="o">(</span>s<span class="o">)</span>
	<span class="nv">spid</span><span class="o">=</span>332 <span class="nv">seq</span><span class="o">=</span>6 <span class="nv">pid</span><span class="o">=</span>24623
	<span class="nv">refcnt</span><span class="o">=</span>1

<span class="gp">sam@sam-T520:/etc/racoon$ </span>

</code></pre>
</div>

<p>##References:</p>
<ol>
  <li>
    <p><a href="http://www.mad-hacking.net/documentation/linux/networking/ipsec/using-racoon-psk.xml">Using the Racoon IKE/ISAKMP daemon</a></p>
  </li>
  <li>
    <p><a href="http://www.mad-hacking.net/documentation/linux/networking/ipsec/nat-vpn.xml">Building a tunnelled VPN using ESP (static IPs, through NAT)</a></p>
  </li>
  <li>
    <p><a href="http://www.kame.net/racoon/racoon.conf.5">Racoon.conf Man page</a></p>
  </li>
</ol>




      </section>
    </div>
  </article>


  <div class="sidebar">
    <nav class="nav__list">
      <div class="wiki-top-links">
        <a href="../wiki" class="display-unset">Wiki Home</a> / <a href="../wikipages" class="display-unset">Wiki Pages</a>
      </div>
      

    



        <ul>
  <li><strong>Deploying IPOP-VPN</strong>
    <ul>
      <li><a href="Quick-Start">Quick Start</a></li>
      <li><a href="Use-IPOP,-Intro">Installation</a></li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>[[Configuration</td>
              <td>Understanding the IPOP Configuration]]</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li><strong>Development Guide</strong>
    <ul>
      <li><a href="Development-Workflow">Development Workflow</a></li>
      <li><a href="Coding-Guidelines">Coding Guidelines</a></li>
      <li><a href="Build-IPOP,-Intro">Building the Code</a></li>
      <li><a href="IPOP-Scale-test-Walkthrough">Testing Your Build</a></li>
      <li><a href="Controller-Framework">Controller Framework</a></li>
      <li><a href="Controller-API">Controller API</a></li>
      <li><a href="Build-WebRTC-Libraries,-Intro">Building WebRTC Libraries</a></li>
    </ul>
  </li>
  <li><strong>General Documentation</strong>
    <ul>
      <li><a href="FAQs">FAQs</a></li>
      <li><a href="Troubleshooting">Troubleshooting</a></li>
      <li><a href="Planning-Your-Network">Planning Your Network</a></li>
      <li><a href="Coding-Challenges">Coding Challenges</a></li>
      <li><a href="Known-Issues">Known Issues</a></li>
      <li><a href="Getting-Help">Getting Help</a></li>
      <li><a href="How-to-Contribute">How to Contribute</a></li>
    </ul>
  </li>
</ul>



      </section>
    </div>
  </article>



</div>




    </nav>
  </div>


</div>



    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <!-- <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
     -->
    <!-- <li><a href="/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> -->
<!--  </ul>
</div> --> 

<div class="page__footer-copyright footer-address">
  <div class="float-left">
    <img src="/assets/images/uf_small.png" class="padding-bottom-right" /><img src="/assets/images/nsf_small.png" class="padding-bottom-right" />
  </div>
  <i class="fa fa-address-card-o" aria-hidden="true"></i>
  <a href="http://www.acis.ufl.edu" rel="nofollow" target="_blank">ACIS Lab</a>, P.O. Box 116200, 339 Larsen Hall, Gainesville, FL 32611-6200; 352.392.4964<br />
  <a href="http://www.ece.ufl.edu/" rel="nofollow" target="_blank">Department of Electrical & Computer Engineering</a><br />
  <a href="http://www.eng.ufl.edu/" rel="nofollow" target="_blank">College of Engineering</a>, <a href="http://www.ufl.edu/" rel="nofollow" target="_blank">University of Florida</a>
</div>

<div class="page__footer-copyright footer-links">
  <div>
    <a href="/contact">Contact</a> | <a href="/contact/#mailing-list-subscription">Mailing List</a> | <a href="https://ipopvpn.slack.com/">Slack Channel</a> | <a href="/sitemap">Sitemap</a><br />
    <div>Powered by <a href="http://jekyllrb.com" rel="nofollow" target="_blank">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow" target="_blank">Minimal Mistakes</a><br />
    &copy; 2019 IPOP - <a href="http://www.acis.ufl.edu" rel="nofollow" target="_blank">ACIS Lab</a>
    </div>
  </div>
</div>
<div class="page__footer-copyright footer-sponsor clear-both">This material is based upon work supported in part by the National Science Foundation under Grants No. 1234983, 1339737 and 1527415.</div>
      </footer>
    </div>

    <script src="/assets/js/main.min.js"></script>





  </body>
</html>

